{
  "_id": "person-crm",
  "type": "pipe",
  "source": {
    "type": "dataset",
    "dataset": "global-person"
  },
  "transform": {
    "type": "dtl",
    "rules": {
      "default": [
        ["filter",
          ["intersects",
            ["list", "~:crm:person", "~:azure:person", "~:firebase:person"], "_S.rdf:type"]
        ],
        ["comment", "hop to global-location and mold data to fit database"],
        ["merge",
          ["apply-hops", "new-rule", {
            "datasets": ["global-location gl"],
            "where": [
              ["eq", "_S.global-person:zipcode", "gl.postnummer"]
            ]
          }]
        ],
        ["comment", "postinfo",
          ["hops", {
            "datasets": ["global-location gl"],
            "where": [
              ["eq", "_S.location", "gl.postnummer"]
            ],
            "return": ["list", "gl.kommunenavn", "gl.postnummer", "gl.rdf:type"]
          }]
        ],
        ["comment", "transforms happen sequencially so here we have access to the resulting data"],
        ["add", "Customerid", "_S.crm-person:Customerid"],
        ["add", "Gender", "_S.crm-person:Gender"],
        ["add", "FirstName", "_S.global-person:firstname"],
        ["add", "MiddleInitial", "_S.crm-person:MiddleInitial"],
        ["add", "SSN", "_S.crm-person:SSN"],
        ["add", "LastName", "_S.global-person:lastname"],
        ["add", "Address", "_S.crm-person:Address"],
        ["add", "PostalCode", "_S.global-person:zipcode"],
        ["add", "EmailAddress", "_S.crm-person:EmailAddress"],
        ["add", "Username", "_S.crm-person:Username"],
        ["add", "Name", "_S.global-person:fullname"]
      ],
      "new-rule": [
        ["add", "Municipality", "_S.kommunenavn"],
        ["add", "City", "_S.poststed"]
      ]
    }
  }
}
